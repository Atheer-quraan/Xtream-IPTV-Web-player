<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>IPTV Stream Player</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/hls.js@latest"></script>
    <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@300;400;600;700;900&family=Space+Grotesk:wght@300;400;500;700&display=swap" rel="stylesheet">
    <style>
        :root {
            --bg-primary: #0a0a0f;
            --bg-secondary: #12121a;
            --card-bg: rgba(20, 20, 30, 0.7);
            --border-color: rgba(255, 255, 255, 0.08);
            --accent-1: #00d4aa;
            --accent-2: #0099ff;
            --accent-3: #ff6b35;
            --text-primary: #ffffff;
            --text-muted: #8a8a9a;
            --glass: rgba(255, 255, 255, 0.03);
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Cairo', sans-serif;
            background: var(--bg-primary);
            color: var(--text-primary);
            min-height: 100vh;
            overflow-x: hidden;
        }

        /* Animated Background */
        .animated-bg {
            position: fixed;
            inset: 0;
            z-index: 0;
            overflow: hidden;
        }

        .gradient-orb {
            position: absolute;
            border-radius: 50%;
            filter: blur(80px);
            opacity: 0.5;
            animation: float 20s ease-in-out infinite;
        }

        .orb-1 {
            width: 600px;
            height: 600px;
            background: radial-gradient(circle, var(--accent-1) 0%, transparent 70%);
            top: -200px;
            right: -100px;
            animation-delay: 0s;
        }

        .orb-2 {
            width: 500px;
            height: 500px;
            background: radial-gradient(circle, var(--accent-2) 0%, transparent 70%);
            bottom: -150px;
            left: -100px;
            animation-delay: -7s;
        }

        .orb-3 {
            width: 400px;
            height: 400px;
            background: radial-gradient(circle, var(--accent-3) 0%, transparent 70%);
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            animation-delay: -14s;
        }

        @keyframes float {
            0%, 100% { transform: translate(0, 0) scale(1); }
            25% { transform: translate(50px, -30px) scale(1.1); }
            50% { transform: translate(-30px, 50px) scale(0.95); }
            75% { transform: translate(-50px, -20px) scale(1.05); }
        }

        /* Grid Pattern */
        .grid-pattern {
            position: fixed;
            inset: 0;
            background-image: 
                linear-gradient(rgba(255,255,255,0.02) 1px, transparent 1px),
                linear-gradient(90deg, rgba(255,255,255,0.02) 1px, transparent 1px);
            background-size: 50px 50px;
            z-index: 1;
            pointer-events: none;
        }

        /* Glass Card */
        .glass-card {
            background: var(--card-bg);
            backdrop-filter: blur(20px);
            border: 1px solid var(--border-color);
            border-radius: 20px;
        }

        /* Input Styling */
        .input-field {
            background: rgba(0, 0, 0, 0.4);
            border: 1px solid var(--border-color);
            border-radius: 12px;
            padding: 14px 18px;
            color: var(--text-primary);
            font-size: 15px;
            width: 100%;
            transition: all 0.3s ease;
            font-family: 'Space Grotesk', sans-serif;
        }

        .input-field:focus {
            outline: none;
            border-color: var(--accent-1);
            box-shadow: 0 0 20px rgba(0, 212, 170, 0.2);
        }

        .input-field::placeholder {
            color: var(--text-muted);
        }

        /* Button Styling */
        .btn-primary {
            background: linear-gradient(135deg, var(--accent-1), var(--accent-2));
            border: none;
            border-radius: 12px;
            padding: 14px 28px;
            color: var(--bg-primary);
            font-weight: 700;
            font-size: 15px;
            cursor: pointer;
            transition: all 0.3s ease;
            position: relative;
            overflow: hidden;
        }

        .btn-primary::before {
            content: '';
            position: absolute;
            inset: 0;
            background: linear-gradient(135deg, var(--accent-2), var(--accent-1));
            opacity: 0;
            transition: opacity 0.3s ease;
        }

        .btn-primary:hover::before {
            opacity: 1;
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 30px rgba(0, 212, 170, 0.3);
        }

        .btn-primary span {
            position: relative;
            z-index: 1;
        }

        .btn-secondary {
            background: var(--glass);
            border: 1px solid var(--border-color);
            border-radius: 10px;
            padding: 10px 20px;
            color: var(--text-primary);
            font-weight: 500;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .btn-secondary:hover {
            background: rgba(255, 255, 255, 0.1);
            border-color: var(--accent-1);
        }

        /* Video Player */
        .video-container {
            background: #000;
            border-radius: 16px;
            overflow: hidden;
            position: relative;
            aspect-ratio: 16/9;
        }

        .video-container video {
            width: 100%;
            height: 100%;
            object-fit: contain;
        }

        /* Channel List */
        .channel-item {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 12px 16px;
            border-radius: 12px;
            cursor: pointer;
            transition: all 0.3s ease;
            border: 1px solid transparent;
        }

        .channel-item:hover {
            background: rgba(0, 212, 170, 0.1);
            border-color: rgba(0, 212, 170, 0.3);
        }

        .channel-item.active {
            background: linear-gradient(135deg, rgba(0, 212, 170, 0.2), rgba(0, 153, 255, 0.2));
            border-color: var(--accent-1);
        }

        .channel-logo {
            width: 44px;
            height: 44px;
            border-radius: 10px;
            background: linear-gradient(135deg, var(--accent-1), var(--accent-2));
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 700;
            font-size: 16px;
            flex-shrink: 0;
        }

        .channel-logo img {
            width: 100%;
            height: 100%;
            object-fit: cover;
            border-radius: 10px;
        }

        /* Category Tabs */
        .category-tab {
            padding: 10px 20px;
            border-radius: 10px;
            cursor: pointer;
            transition: all 0.3s ease;
            font-weight: 500;
            white-space: nowrap;
            border: 1px solid transparent;
        }

        .category-tab:hover {
            background: var(--glass);
        }

        .category-tab.active {
            background: linear-gradient(135deg, var(--accent-1), var(--accent-2));
            color: var(--bg-primary);
        }

        /* Scrollbar */
        ::-webkit-scrollbar {
            width: 6px;
            height: 6px;
        }

        ::-webkit-scrollbar-track {
            background: transparent;
        }

        ::-webkit-scrollbar-thumb {
            background: var(--accent-1);
            border-radius: 10px;
        }

        /* Favorite Button */
        .fav-btn {
            width: 36px;
            height: 36px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.3s ease;
            background: transparent;
            border: none;
        }

        .fav-btn:hover {
            background: rgba(255, 107, 53, 0.2);
        }

        .fav-btn.active svg {
            fill: var(--accent-3);
            stroke: var(--accent-3);
        }

        /* Tabs */
        .tab-btn {
            padding: 12px 24px;
            border-radius: 12px;
            cursor: pointer;
            transition: all 0.3s ease;
            font-weight: 600;
            border: 1px solid transparent;
            background: transparent;
            color: var(--text-muted);
        }

        .tab-btn.active {
            background: var(--glass);
            color: var(--text-primary);
            border-color: var(--border-color);
        }

        .tab-btn:hover:not(.active) {
            color: var(--text-primary);
        }

        /* Animations */
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .fade-in {
            animation: fadeIn 0.5s ease forwards;
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }

        .loading-pulse {
            animation: pulse 1.5s ease-in-out infinite;
        }

        /* Search */
        .search-box {
            position: relative;
        }

        .search-box input {
            padding-right: 45px;
        }

        .search-box svg {
            position: absolute;
            right: 15px;
            top: 50%;
            transform: translateY(-50%);
            color: var(--text-muted);
        }

        /* Responsive */
        @media (max-width: 1024px) {
            .main-grid {
                grid-template-columns: 1fr !important;
            }
            
            .sidebar {
                order: 2;
                max-height: 400px;
            }
        }

        /* File Drop Zone */
        .drop-zone {
            border: 2px dashed var(--border-color);
            border-radius: 16px;
            padding: 40px;
            text-align: center;
            transition: all 0.3s ease;
            cursor: pointer;
        }

        .drop-zone:hover, .drop-zone.dragover {
            border-color: var(--accent-1);
            background: rgba(0, 212, 170, 0.05);
        }

        /* Modal */
        .modal-overlay {
            position: fixed;
            inset: 0;
            background: rgba(0, 0, 0, 0.8);
            backdrop-filter: blur(10px);
            z-index: 100;
            display: flex;
            align-items: center;
            justify-content: center;
            opacity: 0;
            visibility: hidden;
            transition: all 0.3s ease;
        }

        .modal-overlay.active {
            opacity: 1;
            visibility: visible;
        }

        .modal-content {
            transform: scale(0.9);
            transition: transform 0.3s ease;
        }

        .modal-overlay.active .modal-content {
            transform: scale(1);
        }

        /* Reduced Motion */
        @media (prefers-reduced-motion: reduce) {
            *, *::before, *::after {
                animation-duration: 0.01ms !important;
                transition-duration: 0.01ms !important;
            }
        }
    </style>
</head>
<body>
    <!-- Animated Background -->
    <div class="animated-bg">
        <div class="gradient-orb orb-1"></div>
        <div class="gradient-orb orb-2"></div>
        <div class="gradient-orb orb-3"></div>
    </div>
    <div class="grid-pattern"></div>

    <!-- Main Container -->
    <div class="relative z-10 min-h-screen">
        <!-- Header -->
        <header class="p-4 lg:p-6">
            <div class="max-w-7xl mx-auto flex items-center justify-between gap-4">
                <div class="flex items-center gap-3">
                    <div class="w-12 h-12 rounded-xl bg-gradient-to-br from-[#00d4aa] to-[#0099ff] flex items-center justify-center">
                        <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="#0a0a0f" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round">
                            <polygon points="5 3 19 12 5 21 5 3"></polygon>
                        </svg>
                    </div>
                    <div>
                        <h1 class="text-xl lg:text-2xl font-bold">Stream Box</h1>
                        <p class="text-xs text-[#8a8a9a]">IPTV Player</p>
                    </div>
                </div>
                
                <div class="flex items-center gap-3">
                    <button id="addSourceBtn" class="btn-secondary flex items-center gap-2">
                        <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                            <line x1="12" y1="5" x2="12" y2="19"></line>
                            <line x1="5" y1="12" x2="19" y2="12"></line>
                        </svg>
                        <span class="hidden sm:inline">إضافة مصدر</span>
                    </button>
                    <button id="showFavoritesBtn" class="btn-secondary flex items-center gap-2">
                        <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                            <polygon points="12 2 15.09 8.26 22 9.27 17 14.14 18.18 21.02 12 17.77 5.82 21.02 7 14.14 2 9.27 8.91 8.26 12 2"></polygon>
                        </svg>
                        <span class="hidden sm:inline">المفضلة</span>
                    </button>
                </div>
            </div>
        </header>

        <!-- Main Content -->
        <main class="px-4 lg:px-6 pb-8">
            <div class="max-w-7xl mx-auto main-grid grid grid-cols-1 lg:grid-cols-[1fr_380px] gap-6">
                <!-- Player Section -->
                <div class="space-y-6 fade-in">
                    <!-- Video Player -->
                    <div class="glass-card p-4">
                        <div class="video-container">
                            <video id="videoPlayer" controls playsinline>
                                <source src="" type="video/mp4">
                            </video>
                            <div id="playerPlaceholder" class="absolute inset-0 flex flex-col items-center justify-center bg-[#0a0a0f]">
                                <svg width="80" height="80" viewBox="0 0 24 24" fill="none" stroke="#8a8a9a" stroke-width="1" stroke-linecap="round" stroke-linejoin="round">
                                    <circle cx="12" cy="12" r="10"></circle>
                                    <polygon points="10 8 16 12 10 16 10 8" fill="#8a8a9a" stroke="none"></polygon>
                                </svg>
                                <p class="mt-4 text-[#8a8a9a]">اختر قناة لتشغيلها</p>
                            </div>
                        </div>
                        
                        <!-- Now Playing Info -->
                        <div id="nowPlaying" class="mt-4 p-4 rounded-xl bg-black/30 hidden">
                            <div class="flex items-center gap-3">
                                <div id="nowPlayingLogo" class="w-12 h-12 rounded-lg bg-gradient-to-br from-[#00d4aa] to-[#0099ff] flex items-center justify-center font-bold"></div>
                                <div class="flex-1 min-w-0">
                                    <h3 id="nowPlayingTitle" class="font-semibold truncate">اسم القناة</h3>
                                    <p id="nowPlayingCategory" class="text-sm text-[#8a8a9a]">الفئة</p>
                                </div>
                                <button id="addFavBtn" class="fav-btn" title="إضافة للمفضلة">
                                    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="#ff6b35" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                        <polygon points="12 2 15.09 8.26 22 9.27 17 14.14 18.18 21.02 12 17.77 5.82 21.02 7 14.14 2 9.27 8.91 8.26 12 2"></polygon>
                                    </svg>
                                </button>
                            </div>
                        </div>
                    </div>

                    <!-- Tabs -->
                    <div class="glass-card p-2 flex gap-2 overflow-x-auto">
                        <button class="tab-btn active" data-tab="all">الكل</button>
                        <button class="tab-btn" data-tab="favorites">المفضلة</button>
                        <button class="tab-btn" data-tab="recent">الأخيرة</button>
                    </div>

                    <!-- Search -->
                    <div class="search-box">
                        <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                            <circle cx="11" cy="11" r="8"></circle>
                            <line x1="21" y1="21" x2="16.65" y2="16.65"></line>
                        </svg>
                        <input type="text" id="searchInput" class="input-field" placeholder="ابحث عن قناة...">
                    </div>

                    <!-- Categories Scroll -->
                    <div class="flex gap-3 overflow-x-auto pb-2" id="categoriesScroll">
                        <button class="category-tab active" data-category="all">جميع القنوات</button>
                    </div>

                    <!-- Channels Grid -->
                    <div id="channelsGrid" class="grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 gap-3">
                        <!-- Channels will be rendered here -->
                    </div>

                    <!-- Empty State -->
                    <div id="emptyState" class="glass-card p-12 text-center hidden">
                        <svg width="60" height="60" viewBox="0 0 24 24" fill="none" stroke="#8a8a9a" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round" class="mx-auto mb-4">
                            <rect x="2" y="7" width="20" height="15" rx="2" ry="2"></rect>
                            <polyline points="17 2 12 7 7 2"></polyline>
                        </svg>
                        <h3 class="text-lg font-semibold mb-2">لا توجد قنوات</h3>
                        <p class="text-[#8a8a9a]">أضف مصدر IPTV للبدء في المشاهدة</p>
                    </div>
                </div>

                <!-- Sidebar -->
                <div class="sidebar glass-card p-4 h-fit lg:sticky lg:top-6">
                    <h2 class="font-bold text-lg mb-4">القنوات</h2>
                    
                    <!-- Channels List -->
                    <div id="channelsList" class="space-y-2 max-h-[600px] overflow-y-auto">
                        <!-- List items will be rendered here -->
                    </div>

                    <!-- Stats -->
                    <div class="mt-4 pt-4 border-t border-[rgba(255,255,255,0.08)] grid grid-cols-2 gap-3">
                        <div class="text-center p-3 rounded-xl bg-black/30">
                            <div id="totalChannels" class="text-2xl font-bold text-[#00d4aa]">0</div>
                            <div class="text-xs text-[#8a8a9a]">قناة</div>
                        </div>
                        <div class="text-center p-3 rounded-xl bg-black/30">
                            <div id="totalFavorites" class="text-2xl font-bold text-[#ff6b35]">0</div>
                            <div class="text-xs text-[#8a8a9a]">مفضلة</div>
                        </div>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <!-- Add Source Modal -->
    <div id="sourceModal" class="modal-overlay">
        <div class="modal-content glass-card p-6 w-full max-w-lg mx-4">
            <div class="flex items-center justify-between mb-6">
                <h2 class="text-xl font-bold">إضافة مصدر IPTV</h2>
                <button id="closeModal" class="w-10 h-10 rounded-full bg-black/30 flex items-center justify-center hover:bg-black/50 transition-colors">
                    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                        <line x1="18" y1="6" x2="6" y2="18"></line>
                        <line x1="6" y1="6" x2="18" y2="18"></line>
                    </svg>
                </button>
            </div>

            <!-- Source Type Tabs -->
            <div class="flex gap-2 mb-6">
                <button class="source-tab flex-1 py-3 rounded-xl font-semibold transition-all active" data-source="xtream">
                    Xtream Codes
                </button>
                <button class="source-tab flex-1 py-3 rounded-xl font-semibold transition-all" data-source="m3u">
                    ملف M3U
                </button>
            </div>

            <!-- Xtream Form -->
            <div id="xtreamForm" class="space-y-4">
                <div>
                    <label class="block text-sm text-[#8a8a9a] mb-2">رابط السيرفر</label>
                    <input type="text" id="serverUrl" class="input-field" placeholder="http://example.com:port">
                </div>
                <div>
                    <label class="block text-sm text-[#8a8a9a] mb-2">اسم المستخدم</label>
                    <input type="text" id="username" class="input-field" placeholder="username">
                </div>
                <div>
                    <label class="block text-sm text-[#8a8a9a] mb-2">كلمة المرور</label>
                    <input type="password" id="password" class="input-field" placeholder="password">
                </div>
                <div class="flex items-center gap-3">
                    <input type="checkbox" id="saveCredentials" class="w-5 h-5 rounded accent-[#00d4aa]">
                    <label for="saveCredentials" class="text-sm">حفظ بيانات الدخول</label>
                </div>
                <button id="connectXtream" class="btn-primary w-full">
                    <span>اتصال</span>
                </button>
            </div>

            <!-- M3U Form -->
            <div id="m3uForm" class="hidden">
                <div id="dropZone" class="drop-zone mb-4">
                    <svg width="48" height="48" viewBox="0 0 24 24" fill="none" stroke="#8a8a9a" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round" class="mx-auto mb-3">
                        <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path>
                        <polyline points="17 8 12 3 7 8"></polyline>
                        <line x1="12" y1="3" x2="12" y2="15"></line>
                    </svg>
                    <p class="text-[#8a8a9a]">اسحب ملف M3U هنا أو انقر للاختيار</p>
                    <input type="file" id="m3uFile" accept=".m3u,.m3u8" class="hidden">
                </div>

                <div class="text-center text-[#8a8a9a] mb-4">أو</div>

                <div class="space-y-4">
                    <div>
                        <label class="block text-sm text-[#8a8a9a] mb-2">رابط M3U</label>
                        <input type="text" id="m3uUrl" class="input-field" placeholder="http://example.com/playlist.m3u">
                    </div>
                    <button id="loadM3uUrl" class="btn-primary w-full">
                        <span>تحميل</span>
                    </button>
                </div>
            </div>

            <!-- Saved Sources -->
            <div id="savedSources" class="mt-6 pt-6 border-t border-[rgba(255,255,255,0.08)] hidden">
                <h3 class="font-semibold mb-3">المصادر المحفوظة</h3>
                <div id="sourcesList" class="space-y-2"></div>
            </div>
        </div>
    </div>

    <!-- Toast Notification -->
    <div id="toast" class="fixed bottom-6 left-1/2 -translate-x-1/2 glass-card px-6 py-3 rounded-xl opacity-0 transition-all duration-300 z-50">
        <p id="toastMessage"></p>
    </div>

    <script>
        // ==================== Data Storage ====================
        const STORAGE_KEYS = {
            CHANNELS: 'iptv_channels',
            FAVORITES: 'iptv_favorites',
            CREDENTIALS: 'iptv_credentials',
            RECENT: 'iptv_recent',
            SOURCES: 'iptv_sources'
        };

        // ==================== State ====================
        let channels = [];
        let favorites = JSON.parse(localStorage.getItem(STORAGE_KEYS.FAVORITES) || '[]');
        let recentChannels = JSON.parse(localStorage.getItem(STORAGE_KEYS.RECENT) || '[]');
        let currentChannel = null;
        let hlsInstance = null;
        let currentCategory = 'all';
        let currentTab = 'all';
        let searchQuery = '';

        // ==================== DOM Elements ====================
        const videoPlayer = document.getElementById('videoPlayer');
        const playerPlaceholder = document.getElementById('playerPlaceholder');
        const channelsGrid = document.getElementById('channelsGrid');
        const channelsList = document.getElementById('channelsList');
        const categoriesScroll = document.getElementById('categoriesScroll');
        const searchInput = document.getElementById('searchInput');
        const sourceModal = document.getElementById('sourceModal');
        const emptyState = document.getElementById('emptyState');
        const nowPlaying = document.getElementById('nowPlaying');
        const toast = document.getElementById('toast');
        const toastMessage = document.getElementById('toastMessage');

        // ==================== Utility Functions ====================
        function showToast(message, type = 'success') {
            toastMessage.textContent = message;
            toast.style.borderColor = type === 'error' ? '#ff4444' : '#00d4aa';
            toast.style.opacity = '1';
            setTimeout(() => {
                toast.style.opacity = '0';
            }, 3000);
        }

        function saveToStorage(key, data) {
            localStorage.setItem(key, JSON.stringify(data));
        }

        function getFromStorage(key) {
            return JSON.parse(localStorage.getItem(key) || '[]');
        }

        function extractCategories(channelList) {
            const cats = new Set(['all']);
            channelList.forEach(ch => {
                if (ch.group) cats.add(ch.group);
            });
            return Array.from(cats);
        }

        function getChannelInitial(name) {
            return name ? name.charAt(0).toUpperCase() : '?';
        }

        // ==================== M3U Parser ====================
        function parseM3U(content) {
            const lines = content.split('\n');
            const parsedChannels = [];
            let currentChannelData = null;

            for (let i = 0; i < lines.length; i++) {
                const line = lines[i].trim();
                
                if (line.startsWith('#EXTINF:')) {
                    currentChannelData = {
                        id: Date.now() + i,
                        name: '',
                        logo: '',
                        group: 'عام',
                        url: '',
                        epgId: ''
                    };

                    // Parse attributes
                    const groupMatch = line.match(/group-title="([^"]*)"/);
                    if (groupMatch) currentChannelData.group = groupMatch[1] || 'عام';

                    const logoMatch = line.match(/tvg-logo="([^"]*)"/);
                    if (logoMatch) currentChannelData.logo = logoMatch[1];

                    const nameMatch = line.match(/,(.+)$/);
                    if (nameMatch) currentChannelData.name = nameMatch[1].trim();

                    const epgMatch = line.match(/tvg-id="([^"]*)"/);
                    if (epgMatch) currentChannelData.epgId = epgMatch[1];
                } else if (line && !line.startsWith('#') && currentChannelData) {
                    currentChannelData.url = line;
                    if (currentChannelData.name && currentChannelData.url) {
                        parsedChannels.push(currentChannelData);
                    }
                    currentChannelData = null;
                }
            }

            return parsedChannels;
        }

        // ==================== Xtream API ====================
        async function fetchXtreamChannels(url, username, password) {
            const baseUrl = url.replace(/\/$/, '');
            const apiUrl = `${baseUrl}/player_api.php?username=${username}&password=${password}&action=get_live_streams`;
            const categoriesUrl = `${baseUrl}/player_api.php?username=${username}&password=${password}&action=get_live_categories`;

            try {
                const [channelsRes, categoriesRes] = await Promise.all([
                    fetch(apiUrl),
                    fetch(categoriesUrl)
                ]);

                const channelsData = await channelsRes.json();
                const categoriesData = await categoriesRes.json();

                const categoryMap = {};
                categoriesData.forEach(cat => {
                    categoryMap[cat.category_id] = cat.category_name;
                });

                return channelsData.map((ch, i) => ({
                    id: ch.stream_id || Date.now() + i,
                    name: ch.name || `قناة ${i + 1}`,
                    logo: ch.stream_icon || '',
                    group: categoryMap[ch.category_id] || 'عام',
                    url: `${baseUrl}/live/${username}/${password}/${ch.stream_id}.m3u8`,
                    epgId: ch.epg_channel_id || ''
                }));
            } catch (error) {
                console.error('Xtream fetch error:', error);
                throw new Error('فشل الاتصال بالسيرفر');
            }
        }

        // ==================== Video Player ====================
        function playChannel(channel) {
            if (!channel || !channel.url) return;

            currentChannel = channel;
            playerPlaceholder.classList.add('hidden');
            nowPlaying.classList.remove('hidden');

            // Update now playing info
            document.getElementById('nowPlayingTitle').textContent = channel.name;
            document.getElementById('nowPlayingCategory').textContent = channel.group;
            
            const logoEl = document.getElementById('nowPlayingLogo');
            if (channel.logo) {
                logoEl.innerHTML = `<img src="${channel.logo}" alt="${channel.name}" onerror="this.parentElement.innerHTML='${getChannelInitial(channel.name)}'">`;
            } else {
                logoEl.textContent = getChannelInitial(channel.name);
            }

            // Update favorite button
            const favBtn = document.getElementById('addFavBtn');
            const isFav = favorites.some(f => f.id === channel.id);
            favBtn.classList.toggle('active', isFav);

            // Play video
            if (hlsInstance) {
                hlsInstance.destroy();
                hlsInstance = null;
            }

            const url = channel.url;

            if (url.includes('.m3u8') || url.includes('m3u8')) {
                if (Hls.isSupported()) {
                    hlsInstance = new Hls({
                        enableWorker: true,
                        lowLatencyMode: true
                    });
                    hlsInstance.loadSource(url);
                    hlsInstance.attachMedia(videoPlayer);
                    hlsInstance.on(Hls.Events.MANIFEST_PARSED, () => {
                        videoPlayer.play().catch(e => console.log('Autoplay prevented'));
                    });
                    hlsInstance.on(Hls.Events.ERROR, (event, data) => {
                        if (data.fatal) {
                            showToast('خطأ في تحميل القناة', 'error');
                        }
                    });
                } else if (videoPlayer.canPlayType('application/vnd.apple.mpegurl')) {
                    videoPlayer.src = url;
                    videoPlayer.play().catch(e => console.log('Autoplay prevented'));
                }
            } else {
                videoPlayer.src = url;
                videoPlayer.play().catch(e => console.log('Autoplay prevented'));
            }

            // Add to recent
            addToRecent(channel);
            
            // Update active state
            document.querySelectorAll('.channel-item').forEach(el => {
                el.classList.toggle('active', el.dataset.id == channel.id);
            });
        }

        function addToRecent(channel) {
            recentChannels = recentChannels.filter(c => c.id !== channel.id);
            recentChannels.unshift(channel);
            if (recentChannels.length > 20) recentChannels = recentChannels.slice(0, 20);
            saveToStorage(STORAGE_KEYS.RECENT, recentChannels);
        }

        // ==================== Toggle Favorite ====================
        function toggleFavorite(channel) {
            const index = favorites.findIndex(f => f.id === channel.id);
            if (index > -1) {
                favorites.splice(index, 1);
                showToast('تمت الإزالة من المفضلة');
            } else {
                favorites.push(channel);
                showToast('تمت الإضافة للمفضلة');
            }
            saveToStorage(STORAGE_KEYS.FAVORITES, favorites);
            updateStats();
            renderChannels();
        }

        // ==================== Render Functions ====================
        function renderCategories() {
            const categories = extractCategories(channels);
            categoriesScroll.innerHTML = categories.map(cat => `
                <button class="category-tab ${cat === currentCategory ? 'active' : ''}" data-category="${cat}">
                    ${cat === 'all' ? 'جميع القنوات' : cat}
                </button>
            `).join('');

            // Add event listeners
            categoriesScroll.querySelectorAll('.category-tab').forEach(btn => {
                btn.addEventListener('click', () => {
                    currentCategory = btn.dataset.category;
                    renderCategories();
                    renderChannels();
                });
            });
        }

        function getFilteredChannels() {
            let filtered = [...channels];

            // Filter by tab
            if (currentTab === 'favorites') {
                filtered = filtered.filter(ch => favorites.some(f => f.id === ch.id));
            } else if (currentTab === 'recent') {
                filtered = recentChannels;
            }

            // Filter by category
            if (currentCategory !== 'all') {
                filtered = filtered.filter(ch => ch.group === currentCategory);
            }

            // Filter by search
            if (searchQuery) {
                const query = searchQuery.toLowerCase();
                filtered = filtered.filter(ch => 
                    ch.name.toLowerCase().includes(query) ||
                    ch.group.toLowerCase().includes(query)
                );
            }

            return filtered;
        }

        function renderChannels() {
            const filtered = getFilteredChannels();
            
            if (filtered.length === 0) {
                channelsGrid.innerHTML = '';
                emptyState.classList.remove('hidden');
                channelsList.innerHTML = '<p class="text-center text-[#8a8a9a] py-8">لا توجد قنوات</p>';
                return;
            }

            emptyState.classList.add('hidden');

            // Render Grid
            channelsGrid.innerHTML = filtered.map((ch, i) => `
                <div class="channel-item glass-card" data-id="${ch.id}" style="animation-delay: ${i * 30}ms">
                    <div class="channel-logo">
                        ${ch.logo ? `<img src="${ch.logo}" alt="${ch.name}" onerror="this.parentElement.innerHTML='${getChannelInitial(ch.name)}'">` : getChannelInitial(ch.name)}
                    </div>
                    <div class="flex-1 min-w-0">
                        <div class="font-medium truncate text-sm">${ch.name}</div>
                        <div class="text-xs text-[#8a8a9a] truncate">${ch.group}</div>
                    </div>
                    <button class="fav-btn ${favorites.some(f => f.id === ch.id) ? 'active' : ''}" data-channel='${JSON.stringify(ch).replace(/'/g, "\\'")}'>
                        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="#ff6b35" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                            <polygon points="12 2 15.09 8.26 22 9.27 17 14.14 18.18 21.02 12 17.77 5.82 21.02 7 14.14 2 9.27 8.91 8.26 12 2"></polygon>
                        </svg>
                    </button>
                </div>
            `).join('');

            // Render List
            channelsList.innerHTML = filtered.slice(0, 50).map(ch => `
                <div class="channel-item ${currentChannel && currentChannel.id === ch.id ? 'active' : ''}" data-id="${ch.id}">
                    <div class="channel-logo">
                        ${ch.logo ? `<img src="${ch.logo}" alt="${ch.name}" onerror="this.parentElement.innerHTML='${getChannelInitial(ch.name)}'">` : getChannelInitial(ch.name)}
                    </div>
                    <div class="flex-1 min-w-0">
                        <div class="font-medium truncate text-sm">${ch.name}</div>
                        <div class="text-xs text-[#8a8a9a] truncate">${ch.group}</div>
                    </div>
                </div>
            `).join('');

            // Add click handlers
            document.querySelectorAll('.channel-item').forEach(item => {
                item.addEventListener('click', (e) => {
                    if (e.target.closest('.fav-btn')) return;
                    const id = item.dataset.id;
                    const channel = channels.find(c => c.id == id);
                    if (channel) playChannel(channel);
                });
            });

            document.querySelectorAll('.fav-btn').forEach(btn => {
                btn.addEventListener('click', (e) => {
                    e.stopPropagation();
                    try {
                        const channel = JSON.parse(btn.dataset.channel.replace(/\\'/g, "'"));
                        toggleFavorite(channel);
                    } catch (err) {
                        console.error('Parse error:', err);
                    }
                });
            });
        }

        function updateStats() {
            document.getElementById('totalChannels').textContent = channels.length;
            document.getElementById('totalFavorites').textContent = favorites.length;
        }

        function renderSavedSources() {
            const sources = getFromStorage(STORAGE_KEYS.SOURCES);
            const sourcesList = document.getElementById('sourcesList');
            const savedSources = document.getElementById('savedSources');

            if (sources.length === 0) {
                savedSources.classList.add('hidden');
                return;
            }

            savedSources.classList.remove('hidden');
            sourcesList.innerHTML = sources.map((src, i) => `
                <div class="flex items-center justify-between p-3 rounded-xl bg-black/30">
                    <div>
                        <div class="font-medium text-sm">${src.name || 'مصدر IPTV'}</div>
                        <div class="text-xs text-[#8a8a9a]">${src.type}</div>
                    </div>
                    <button class="load-source-btn btn-secondary text-xs py-2 px-3" data-index="${i}">
                        تحميل
                    </button>
                </div>
            `).join('');

            document.querySelectorAll('.load-source-btn').forEach(btn => {
                btn.addEventListener('click', () => {
                    const index = parseInt(btn.dataset.index);
                    loadSource(sources[index]);
                });
            });
        }

        async function loadSource(source) {
            showToast('جاري تحميل القنوات...');
            
            try {
                if (source.type === 'xtream') {
                    channels = await fetchXtreamChannels(source.url, source.username, source.password);
                } else if (source.url) {
                    const res = await fetch(source.url);
                    const content = await res.text();
                    channels = parseM3U(content);
                }
                
                saveToStorage(STORAGE_KEYS.CHANNELS, channels);
                renderCategories();
                renderChannels();
                updateStats();
                showToast(`تم تحميل ${channels.length} قناة`);
                sourceModal.classList.remove('active');
            } catch (error) {
                showToast(error.message || 'فشل تحميل القنوات', 'error');
            }
        }

        // ==================== Event Listeners ====================
        
        // Modal Controls
        document.getElementById('addSourceBtn').addEventListener('click', () => {
            sourceModal.classList.add('active');
            renderSavedSources();
        });

        document.getElementById('closeModal').addEventListener('click', () => {
            sourceModal.classList.remove('active');
        });

        sourceModal.addEventListener('click', (e) => {
            if (e.target === sourceModal) {
                sourceModal.classList.remove('active');
            }
        });

        // Source Type Tabs
        document.querySelectorAll('.source-tab').forEach(tab => {
            tab.addEventListener('click', () => {
                document.querySelectorAll('.source-tab').forEach(t => t.classList.remove('active'));
                tab.classList.add('active');
                
                const source = tab.dataset.source;
                document.getElementById('xtreamForm').classList.toggle('hidden', source !== 'xtream');
                document.getElementById('m3uForm').classList.toggle('hidden', source !== 'm3u');
            });
        });

        // Add styles for source tabs
        const style = document.createElement('style');
        style.textContent = `
            .source-tab {
                background: transparent;
                color: var(--text-muted);
                border: 1px solid var(--border-color);
            }
            .source-tab.active {
                background: linear-gradient(135deg, var(--accent-1), var(--accent-2));
                color: var(--bg-primary);
                border-color: transparent;
            }
        `;
        document.head.appendChild(style);

        // Xtream Connect
        document.getElementById('connectXtream').addEventListener('click', async () => {
            const url = document.getElementById('serverUrl').value.trim();
            const username = document.getElementById('username').value.trim();
            const password = document.getElementById('password').value.trim();

            if (!url || !username || !password) {
                showToast('الرجاء إدخال جميع البيانات', 'error');
                return;
            }

            const saveCreds = document.getElementById('saveCredentials').checked;
            if (saveCreds) {
                const sources = getFromStorage(STORAGE_KEYS.SOURCES);
                sources.push({
                    type: 'xtream',
                    name: url.split('//')[1]?.split(':')[0] || 'Xtream',
                    url, username, password
                });
                saveToStorage(STORAGE_KEYS.SOURCES, sources);
            }

            await loadSource({ type: 'xtream', url, username, password });
        });

        // M3U File Upload
        const dropZone = document.getElementById('dropZone');
        const m3uFile = document.getElementById('m3uFile');

        dropZone.addEventListener('click', () => m3uFile.click());

        dropZone.addEventListener('dragover', (e) => {
            e.preventDefault();
            dropZone.classList.add('dragover');
        });

        dropZone.addEventListener('dragleave', () => {
            dropZone.classList.remove('dragover');
        });

        dropZone.addEventListener('drop', (e) => {
            e.preventDefault();
            dropZone.classList.remove('dragover');
            const file = e.dataTransfer.files[0];
            if (file) handleM3UFile(file);
        });

        m3uFile.addEventListener('change', (e) => {
            const file = e.target.files[0];
            if (file) handleM3UFile(file);
        });

        function handleM3UFile(file) {
            const reader = new FileReader();
            reader.onload = (e) => {
                const content = e.target.result;
                channels = parseM3U(content);
                saveToStorage(STORAGE_KEYS.CHANNELS, channels);
                renderCategories();
                renderChannels();
                updateStats();
                showToast(`تم تحميل ${channels.length} قناة`);
                sourceModal.classList.remove('active');
            };
            reader.readAsText(file);
        }

        // M3U URL Load
        document.getElementById('loadM3uUrl').addEventListener('click', async () => {
            const url = document.getElementById('m3uUrl').value.trim();
            if (!url) {
                showToast('الرجاء إدخال رابط M3U', 'error');
                return;
            }

            try {
                showToast('جاري تحميل الملف...');
                const res = await fetch(url);
                const content = await res.text();
                channels = parseM3U(content);
                
                const sources = getFromStorage(STORAGE_KEYS.SOURCES);
                sources.push({
                    type: 'm3u',
                    name: url.split('/').pop() || 'M3U Playlist',
                    url
                });
                saveToStorage(STORAGE_KEYS.SOURCES, sources);
                
                saveToStorage(STORAGE_KEYS.CHANNELS, channels);
                renderCategories();
                renderChannels();
                updateStats();
                showToast(`تم تحميل ${channels.length} قناة`);
                sourceModal.classList.remove('active');
            } catch (error) {
                showToast('فشل تحميل الملف', 'error');
            }
        });

        // Tab Buttons
        document.querySelectorAll('.tab-btn').forEach(btn => {
            btn.addEventListener('click', () => {
                document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
                btn.classList.add('active');
                currentTab = btn.dataset.tab;
                renderChannels();
            });
        });

        // Search
        let searchTimeout;
        searchInput.addEventListener('input', (e) => {
            clearTimeout(searchTimeout);
            searchTimeout = setTimeout(() => {
                searchQuery = e.target.value;
                renderChannels();
            }, 300);
        });

        // Favorite Button in Player
        document.getElementById('addFavBtn').addEventListener('click', () => {
            if (currentChannel) {
                toggleFavorite(currentChannel);
                const isFav = favorites.some(f => f.id === currentChannel.id);
                document.getElementById('addFavBtn').classList.toggle('active', isFav);
            }
        });

        // Show Favorites
        document.getElementById('showFavoritesBtn').addEventListener('click', () => {
            document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
            document.querySelector('[data-tab="favorites"]').classList.add('active');
            currentTab = 'favorites';
            renderChannels();
        });

        // ==================== Initialize ====================
        function init() {
            // Load saved channels
            channels = getFromStorage(STORAGE_KEYS.CHANNELS);
            
            if (channels.length > 0) {
                renderCategories();
                renderChannels();
                updateStats();
            } else {
                emptyState.classList.remove('hidden');
            }
        }

        init();
    </script>
</body>
</html>
